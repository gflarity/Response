var fs = require('fs');

//load the config
var config = JSON.parse( fs.readFileSync( require.resolve('./config.json') ) );


module.exports = function( graphite_emitter, dispatch_emitter ) {
    
    var last_seen = new Date().getTime();    
    
    var on_nervous_heartbeat = function( value, timestamp ) {        

        var now = new Date().getTime();
        var delta = now - last_seen;
        if ( delta > config.timeout ) {
            
            //create some context, put whatever you want
            //from and graphite_event are required by convention
            var context = {
                from : 'nervous_hearbeat_watcher',
                graphite_event : { path : this.event, value : value, timestamp : timestamp },
                now : now,
                last_seen : last_seen,
            };
            
            //tell anyone who's interested that we've hit a condition we're watching for
            dispatch_emitter.emit( config.on_timeout, context );                                         
        }
        else {
            
            //we're fine, keep watching though
            last_seen = now;
        }
    
    };
    graphite_emitter.on ( 'nervous.heartbeat', on_nervous_heartbeat ); 
    
};
