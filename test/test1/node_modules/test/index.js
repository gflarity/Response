module.exports = function( graphite_emitter, dispatch_emitter ) {
        
    var test_succeeded = false;
    var heartbeat_count = 0;
    
    //check if we suceeded in 10 seconds
    var on_timeout = function() {
    
        console.log( 'Emitters seem to be working?: ' + test_succeeded  );
        process.exit(0);    
        
    };
    setTimeout( on_timeout, 10000 );
    
    var on_nervous_heartbeat = function( value, timestamp ) {        

        heartbeat_count++;
        if ( heartbeat_count === 3 ) {
            
            var context = {
                from : 'nervous_hearbeat_watcher',
                graphite_event : { path : this.event, value : value, timestamp : timestamp },
            };
            dispatch_emitter.emit( 'test', context );                                         
        }
    };
    graphite_emitter.on ( 'nervous.heartbeat', on_nervous_heartbeat ); 
    
    var on_test_event = function( context ) {

          test_succeeded = true;
    };
    dispatch_emitter.on ( 'test', on_test_event );
};
